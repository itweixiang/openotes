- zk有哪些特点？

  - 顺序一致性，客户端发送的多个请求能被顺序处理
  - 原子性，事务请求最终都能应用到全部节点，或者全部节点都拒绝事务
  - 单一视图，客户端不管连接到集群的哪个节点，最终读写的数据都是一样的
  - 可靠性，支持集群部署，不会因为单一节点故障而导致服务不可用
  - 数据一致性，可以保证大多是情况下的强一致性，可以保证极端情况下的最终一致性

  

- zk有哪些类型的数据节点？

  持久无序节点、持久有序节点、临时无序节点、临时有序节点



- zk有哪些常用的命令？

  - ls ，查看路径下有哪些节点
  - get，获取某节点存储的数据
  - set，设置节点存储的数据
  - create，创建节点，可以指定参数s，设置为顺序节点，指定参数t，设置为临时节点
  - delete，删除节点
  - quit，退出控制台

  

- zk有哪些常用的工具？

  - zkCli.sh，启动客户端，默认连接本地2181端口
  - zkServer.sh，服务器启动、关闭

  

- zk如何实现权限控制？

  - UGO，user/group/others，linux系统常用的权限控制

  - ACL，access control list，访问控制列表，zk使用，包括三个方面

    - 权限模式

      - ip，ip地址进行控制
      - world，全世界都可以访问
      - auth，明文密码
      - digest，加密密码

    - 授权对象

      - ip，授权ip网段
      - world，所有用户
      - digest、supper，某个用户

    - 具体权限

      增删改查、管理者权限

      

- chroot有什么作用？

  相当于多租户，客户端设置了名称空间的情况下，享有一颗独立的树



- zk节点有哪些角色？

  zk的选举协议参考于paxos，角色和paxos算法一样，有leader、follower、observer三种角色

  - Leader，集群只能有一个leader，负责数据的写入和同步
  - Follower，可以处理读请求，并且可以参加选举
  - Observer，可以处理读请求，但是不能参加选举

  

- zk节点有哪些状态？

  - LOOKING，follower处于选举中的状态
  - LEADING、FOLLOWING、OBSERVING，分别是leader、follower、observer正常时的状态

  

- zk数据的写入流程是怎样的？

  - 往leader节点写入，leader完成自身写入后，同步半数节点，完成后返回响应，并继续写完剩下的节点
  - 往follower节点写入，follower转发给leader，leader完成自身写入后，同步半数节点，完成后返回响应，follower再返回给客户端。leader继续写完剩下的节点。

  

- 节点宕机处理处理？部署规格是怎样的？

  - 若发生宕机则需要细分具体的原因，如可能是资源不够，堆内存太小等
  - 部署规格为2n+1个节点，如1、3、5，可以保证n各节点宕机，集群可以正常提供服务

  

- zk集群如何进行选举？

  根据节点的任期、事务Id、SID进行比较，任期大则直接升胜出，相同则向后比较

  - 集群启动，每个节点启动时发起一次选举，自己投自己一票，然后节点交换选票信息，将自己的选票投给myid更大的节点。直到有节点获得法定数量的投票，则集群选举成功，否则节点将处于LOOKING状态。
  - 节点加入，发起一次投票，原有集群已经选出leader，节点收到响应后，将自己的状态置为FOLLOWING，成为follower节点
  - leader宕机，集群内根据任期、事务Id、SID进行比较，较大者成为leader
  - myid为启动时配置，也等于SID



- 什么情况下zk会发生脑裂？应该怎么处理？

  客户端保留了旧leader的连接，并且在集群未完成新leader选举时，往旧leader读写数据

  无法避免，业务方需要评估其影响，确认是否需要使用zk

  

- zk集群支持动态添加机器吗？

  3.5之前的版本不支持动态扩容，我们在k8s部署时，更新配置后，会逐一对节点进行重启，以保证集群可以提供持续提供服务

  

- zk节点如何进行数据同步？

  - 集群正常时，则每次写入都进行同步
  - 刚完成选举时，leader会将自己本地的数据同步给follower和observer。若follower有leader没有的事务，则follower进行回滚。

  

- zk的watch机制是什么？

  客户端对一个zk节点发起监听，当节点或者该节点的子节点更新时，服务端向客户端进行一个通知回调

  

- zk对节点的 watch 监听通知是永久的吗？

  不是永久的，一次监听只能触发一次，服务节点变更频繁，服务端需要多次回调客户端，将给服务端造成很大的压力。官方的java client不是永久的，但有些第三方的client可以继续watch。



- zk有哪些客户端？
  - zookeeper，官方的，watch只能回调一次，session过期是，无法重连
  - 101tec，这个sdk的网站已经被不正经的人给买了，很多公司用，目前已经停止更新。解决了官方的两个问题
  - curator，奈飞出的，解决了官方两个问题的同时，API比较优化，还有较多的分布式功能，如分布式锁



- zk如何保证事务的顺序一致性的？

  强leader，写请求只能通过leader进行，follower即使接收到了写请求，也只会转发给leader。leader通过一个64位的事务id，高32位为任期，低32位用来计数，传递到半数以上的节点执行，并且成功，才认为事务成功。

  

- zab算法和paxos算法有什么区别？

  zab参考自paxos算法，zk为了保证顺序一致性，所以只有单leader。

  

- zk有哪些应用场景？

  分布式锁、元数据存储、数据发布和订阅

  

- 如何实现分布式锁？

  - 公平锁，创建临时有序节点，若已经存在，则监听最后一个顺序节点，当该节点删除回调时，则进行创建新的顺序节点，处理完则删除，触发下一个锁创建
  - 非公平锁，监听一个临时节点，并在删除时尝试创建该节点，谁先创建就抢到锁，处理完后再将节点删除，触发新一轮的锁争抢



- zk客户端从从节点读取数据，如何保证从节点的数据和主节点的数据时强一致性的？

  客户端先发送指令让从节点从主节点同步数据，然后客户端再从主节点上读取数据